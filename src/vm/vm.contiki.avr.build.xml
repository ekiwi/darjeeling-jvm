<project>

	<import file="../../taskdefs.xml"/>

	<target name="all" depends="compile"/>

	<target name="embeddedloader">
		<embeddedloader
			infusions="${infusions}"
			nativeinfusions="${nativeinfusions}"
			run="${run}"
			cfile="${vm.generated}/loader.c"
			hfile="${vm.generated}/loader.h"
			avr="true"
			/>
	</target>
	
	<target name="compile" depends="embeddedloader">
		<mkdir dir="${vm.objects}/${distro}"/>
		<mkdir dir="${vm.executables}/${distro}"/>
		
		<!-- create .co file -->
		<cc 
			name="gcc"
			objdir="${vm.objects}/${distro}"
		>
		
			<compiler classname="net.sf.antcontrib.cpptasks.gcc.cross.GccCCompiler">
				<compilerparam value="avr" name="target"/>
				<compilerarg value="-Wall"/>
				<compilerarg value="-mmcu=atmega128"/>
				<compilerarg value="-gdwarf-2"/>				
				<compilerarg value="-Os"/>
				<compilerarg value="-c"/>
				<compilerarg value="-o"/>
				<compilerarg value="main.co"/>
				<compilerarg value="-DAUTOSTART_ENABLE"/>
			</compiler>

			<!-- include directories -->
			<includepath>
				<pathelement path="${env.CONTIKI}/cpu/avr/"/> 
				<pathelement path="${env.CONTIKI}/platform/tnode/"/> 
				<pathelement path="${env.CONTIKI}/platform/tnode/dev"/> 
				<pathelement path="${env.CONTIKI}/platform/tnode/apps"/> 
				<pathelement path="${env.CONTIKI}/platform/tnode/net"/> 
				<pathelement path="${env.CONTIKI}/platform/tnode/loader"/> 
				<pathelement path="${env.CONTIKI}/core/dev"/> 
				<pathelement path="${env.CONTIKI}/core/lib"/> 
				<pathelement path="${env.CONTIKI}/core/net"/> 
				<pathelement path="${env.CONTIKI}/core/net/mac"/> 
				<pathelement path="${env.CONTIKI}/core/net/rime"/> 
				<pathelement path="${env.CONTIKI}/core/sys"/> 
				<pathelement path="${env.CONTIKI}/core/cfs"/> 
				<pathelement path="${env.CONTIKI}/core/ctk"/>
				<pathelement path="${env.CONTIKI}/core/lib/ctk"/> 
				<pathelement path="${env.CONTIKI}/core/loader"/> 
				<pathelement path="${env.CONTIKI}/core/"/>
				<pathelement path="${lib.generated}"/>
				<pathelement path="${app.generated}"/>
				<pathelement path="${vm.base}"/>
				<pathelement path="${vm.base}/cpu/${cpu}"/>
				<pathelement path="${vm.base}/platform/${platform}"/>
				<pathelement path="${vm.base}/distro/${distro}"/>
			</includepath>
			
			<fileset dir="${vm.base}/platform/${platform}">
				<include name="main.c"/>
			</fileset>
		
		</cc>

		<cc 
			name="gcc"
			objdir="${vm.objects}/${distro}"
		>
			<compiler classname="net.sf.antcontrib.cpptasks.gcc.cross.GccCCompiler">
				<compilerparam value="avr" name="target"/>
				<compilerarg value="-Wall"/>
				<compilerarg value="-mmcu=atmega128"/>
				<compilerarg value="-gdwarf-2"/>				
				<compilerarg value="-Os"/>
				<compilerarg value="-c"/>
				<compilerarg value="-DAUTOSTART_ENABLE"/>
				<compilerarg value="-DCONTIKI_TARGET=tnode"/>
			</compiler>

			<!-- include directories -->
			<includepath>
				<pathelement path="${env.CONTIKI}/cpu/avr/"/> 
				<pathelement path="${env.CONTIKI}/platform/tnode/"/> 
				<pathelement path="${env.CONTIKI}/platform/tnode/dev"/> 
				<pathelement path="${env.CONTIKI}/platform/tnode/apps"/> 
				<pathelement path="${env.CONTIKI}/platform/tnode/net"/> 
				<pathelement path="${env.CONTIKI}/platform/tnode/loader"/> 
				<pathelement path="${env.CONTIKI}/core/dev"/> 
				<pathelement path="${env.CONTIKI}/core/lib"/> 
				<pathelement path="${env.CONTIKI}/core/net"/> 
				<pathelement path="${env.CONTIKI}/core/net/mac"/> 
				<pathelement path="${env.CONTIKI}/core/net/rime"/> 
				<pathelement path="${env.CONTIKI}/core/sys"/> 
				<pathelement path="${env.CONTIKI}/core/cfs"/> 
				<pathelement path="${env.CONTIKI}/core/ctk"/>
				<pathelement path="${env.CONTIKI}/core/lib/ctk"/> 
				<pathelement path="${env.CONTIKI}/core/loader"/> 
				<pathelement path="${env.CONTIKI}/core/"/>
				<pathelement path="${lib.generated}"/>
				<pathelement path="${app.generated}"/>
				<pathelement path="${vm.base}"/>
				<pathelement path="${vm.base}/cpu/${cpu}"/>
				<pathelement path="${vm.base}/platform/${platform}"/>
				<pathelement path="${vm.base}/distro/${distro}"/>
			</includepath>
			
			<fileset dir="${vm.base}/common"><include name="**/*.c"/></fileset>
			<fileset dir="${vm.base}/cpu/${cpu}"><include name="**/*.c"/></fileset>
			<fileset dir="${vm.base}/platform/${platform}"><exclude name="main.c"/><include name="**/*.c"/></fileset>
			<fileset dir="${vm.base}/distro/${distro}"><include name="**/*.c"/></fileset>
			<fileset dir="${vm.opt}"><patternset refid="opt"/></fileset>
			<fileset dir="${vm.generated}"><include name="loader.c"/></fileset>
		
		</cc>

		<cc outfile="${vm.executables}/${distro}/darjeeling.elf" 
			objdir="${vm.objects}/${distro}"
			debug="false"
			>

			<linker classname="net.sf.antcontrib.cpptasks.gcc.cross.GccLinker">
				<linkerparam value="avr" name="target"/>
				<linkerarg value="-Wl,--cref,-Map,darjeeling-avr.map,--section-start=.bootloader=0x1e000"/>
				<linkerarg value="-mmcu=atmega128"/>
			</linker>

			<libset libs="c" />
			<fileset dir="${vm.objects}/${distro}/"><include name="*.o"/><include name="*.co"/></fileset>
			<fileset dir="${lib}/"><include name="contiki-tnode.a"/></fileset>
		</cc>
		
	</target>

	<target name="run" depends="compile">
		
		<!-- create srec file -->
		<exec executable="avr-objcopy">
			<arg value="-R"/>
			<arg value="-S"/>
			<arg value="--target=srec"/>
			<arg value="${vm.executables}/${distro}/darjeeling.elf"/>
			<arg value="${vm.executables}/${distro}/darjeeling.srec"/>
		</exec>
		
		<!-- upload and run -->
		<exec executable="uisp">
			<arg value="-v=3"/>
			<arg value="-dprog=ftdi"/>
			<arg value="-dpart=ATmega128"/>
			<arg value="--wr_fuse_e=ff"/>
			<arg value="-dinvert=mosi,miso,sck"/>
			<arg value="--erase"/>
			<arg value="--upload"/>
			<arg value="if=${vm.executables}/${distro}/darjeeling.srec"/>
		</exec>
		
	</target>

</project>
